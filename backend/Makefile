.PHONY: help install lint format test qa security clean pre-commit-install pre-commit-run

# Variables
PYTHON := python3
PIP := $(PYTHON) -m pip
PYTEST := pytest
VENV := venv

help:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘           Backend Makefile Commands                        â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Setup:"
	@echo "  make install              - Install all dependencies"
	@echo "  make pre-commit-install   - Install pre-commit hooks"
	@echo ""
	@echo "Code Quality:"
	@echo "  make lint                 - Run all linters (flake8, pylint, mypy)"
	@echo "  make format               - Auto-format code (black + isort)"
	@echo "  make pre-commit-run       - Run pre-commit on all files"
	@echo ""
	@echo "Testing:"
	@echo "  make test                 - Run tests with coverage"
	@echo "  make test-unit            - Run unit tests only"
	@echo "  make test-integration     - Run integration tests only"
	@echo ""
	@echo "Security:"
	@echo "  make security             - Run security checks (bandit + safety)"
	@echo ""
	@echo "Complete QA:"
	@echo "  make qa                   - Run full QA suite (format + lint + test + security)"
	@echo ""
	@echo "Maintenance:"
	@echo "  make clean                - Clean cache and build files"
	@echo ""

install:
	@echo "ðŸ“¦ Installing production dependencies..."
	$(PIP) install --upgrade pip
	$(PIP) install -r requirements.txt
	@echo "ðŸ“¦ Installing development dependencies..."
	$(PIP) install -r requirements-dev.txt
	@echo "âœ“ Dependencies installed"

pre-commit-install:
	@echo "ðŸ”— Installing pre-commit hooks..."
	pre-commit install
	@echo "âœ“ Pre-commit hooks installed"

pre-commit-run:
	@echo "ðŸ” Running pre-commit on all files..."
	pre-commit run --all-files

lint:
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "Running Code Quality Checks..."
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "1ï¸âƒ£  Running Flake8..."
	@flake8 app/ || (echo "âŒ Flake8 found issues" && exit 1)
	@echo "âœ“ Flake8 passed"
	@echo ""
	@echo "2ï¸âƒ£  Running Pylint..."
	@pylint app/ --rcfile=.pylintrc || (echo "âš ï¸  Pylint found issues (non-blocking)" && true)
	@echo ""
	@echo "3ï¸âƒ£  Running MyPy type checking..."
	@mypy app/ --config-file=mypy.ini || (echo "âš ï¸  MyPy found type issues (non-blocking)" && true)
	@echo ""
	@echo "4ï¸âƒ£  Checking import sorting (isort)..."
	@isort --check-only --diff app/ || (echo "âŒ Imports not sorted correctly" && exit 1)
	@echo "âœ“ Import sorting is correct"
	@echo ""
	@echo "5ï¸âƒ£  Checking code formatting (black)..."
	@black --check app/ || (echo "âŒ Code not formatted correctly" && exit 1)
	@echo "âœ“ Code formatting is correct"
	@echo ""
	@echo "âœ… All linting checks passed!"

format:
	@echo "ðŸŽ¨ Auto-formatting code..."
	@echo ""
	@echo "Sorting imports with isort..."
	@isort app/
	@echo "âœ“ Imports sorted"
	@echo ""
	@echo "Formatting code with black..."
	@black app/
	@echo "âœ“ Code formatted"
	@echo ""
	@echo "âœ… Code formatting complete!"

test:
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "Running Tests with Coverage..."
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@$(PYTEST) || (echo "âŒ Tests failed" && exit 1)
	@echo ""
	@echo "âœ… All tests passed!"
	@echo ""
	@echo "ðŸ“Š Coverage report generated in htmlcov/index.html"

test-unit:
	@echo "ðŸ§ª Running unit tests..."
	@$(PYTEST) -m unit

test-integration:
	@echo "ðŸ”— Running integration tests..."
	@$(PYTEST) -m integration

security:
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "Running Security Checks..."
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "1ï¸âƒ£  Running Bandit security scan..."
	@bandit -r app/ -c .bandit -f screen || (echo "âš ï¸  Security issues found" && true)
	@bandit -r app/ -c .bandit -f json -o reports/bandit-report.json 2>/dev/null || true
	@echo ""
	@echo "2ï¸âƒ£  Checking dependencies for vulnerabilities (Safety)..."
	@safety check --json > reports/safety-report.json 2>/dev/null || true
	@safety check || (echo "âš ï¸  Vulnerable dependencies found" && true)
	@echo ""
	@echo "âœ… Security checks complete!"

qa: format lint test security
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘                                                            â•‘"
	@echo "â•‘              âœ…  QA SUITE COMPLETED SUCCESSFULLY!          â•‘"
	@echo "â•‘                                                            â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Summary:"
	@echo "  âœ“ Code formatted (black + isort)"
	@echo "  âœ“ Linting passed (flake8 + pylint + mypy)"
	@echo "  âœ“ Tests passed with coverage"
	@echo "  âœ“ Security checks completed"
	@echo ""

clean:
	@echo "ðŸ§¹ Cleaning up..."
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@find . -type f -name "*.pyo" -delete 2>/dev/null || true
	@find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	@rm -rf .coverage htmlcov/ .mypy_cache/ reports/ *.log 2>/dev/null || true
	@echo "âœ“ Cleanup complete!"

# Create reports directory if it doesn't exist
reports:
	@mkdir -p reports